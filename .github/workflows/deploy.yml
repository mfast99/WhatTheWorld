name: Deploy to Hetzner

on:
  push:
    branches: [ "main" ] # Oder "master", je nach deinem Branch-Namen

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Code auschecken
    - uses: actions/checkout@v4

    # 2. .NET Backend bauen (FINAL KORRIGIERT)
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build Backend
      run: |
        # 1. In das SLN-Verzeichnis wechseln und Pakete wiederherstellen
        cd backend/src
        dotnet restore WhatTheWorld.sln
        
        # 2. Solution publishen. Output liegt in ./publish
        dotnet publish WhatTheWorld.sln -c Release -o ./publish
        
        # 3. Die fertigen Binaries in den temporären Upload-Ordner VERSCHIEBEN.
        #    Der Ordner MUSS im Repo-Root liegen, damit SCP ihn findet.
        #    Wir nutzen hier absoluten Pfad zum Repo-Root: ${{ github.workspace }}
        
        # Sicherstellen, dass der Upload-Ordner existiert (im Repo-Root)
        mkdir -p ${{ github.workspace }}/temp_backend_publish
        
        # Verschiebe den Output (./publish/*) in den neuen temporären Ordner
        rsync -a ./publish/ ${{ github.workspace }}/temp_backend_publish/   

    # 3. React Frontend bauen (Bleibt gleich)
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build

    # 4. Dateien auf den Server kopieren (JETZT ZUVERLÄSSIGER!)
    # Wir laden beide Ordner einzeln hoch, um Fehler zu vermeiden.
    - name: Copy Backend to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "temp_backend_publish/*" # Wir kopieren den INHALT
        target: "/var/www/whattheworld_temp/backend/"
        strip_components: 0

    - name: Copy Frontend to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "frontend/dist/*" # Wir kopieren den INHALT
        target: "/var/www/whattheworld_temp/frontend/"
        strip_components: 0

# 5. Move files and restart (FINAL KORREKTUR DER PFADE)
    - name: Move files and restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # 1. Backend verschieben (Binaries): Kopiert den INHALT
          rsync -av --delete /var/www/whattheworld_temp/backend/temp_backend_publish/ /var/www/whattheworld/backend/
          
          # 2. Frontend verschieben (optional, aber nützlich für Backups)
          rsync -av --delete /var/www/whattheworld_temp/frontend/ /var/www/whattheworld/frontend/
          
          # 3. KORREKTUR: wwwroot im Backend erstellen (falls es nicht existiert)
          sudo mkdir -p /var/www/whattheworld/backend/wwwroot
          
          # 4. KORREKTUR: Frontend-Assets in den wwwroot des Backends kopieren
          # Die Frontend-Assets liegen in /var/www/whattheworld_temp/frontend/
          # Wir kopieren den INHALT (index.html, assets/ etc.)
          sudo cp -r /var/www/whattheworld_temp/frontend/. /var/www/whattheworld/backend/wwwroot/
          
          # 5. Temp löschen
          rm -rf /var/www/whattheworld_temp
          
          # 6. Berechtigungen korrigieren (NEU und VORHERIGES ZUSAMMEN)
          sudo chown -R www-data:www-data /var/www/whattheworld/backend/
          # Setzt 755 (rwx r-x r-x) für Ordner (wichtig für Durchsuchbarkeit)
          sudo find /var/www/whattheworld/backend/wwwroot -type d -exec chmod 755 {} \;
          # Setzt 644 (rw- r-- r--) für Dateien (wichtig für Lesbarkeit)
          sudo find /var/www/whattheworld/backend/wwwroot -type f -exec chmod 644 {} \;
          chmod 755 /var/www/whattheworld/backend/WhatTheWorld.Api.dll # Für das Backend-Binary
          
          # 7. Service neustarten
          systemctl daemon-reload
          systemctl restart whattheworld-backend