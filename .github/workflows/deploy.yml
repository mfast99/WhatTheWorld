name: Deploy to Hetzner

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build Backend
        run: |
          cd backend/src
          dotnet restore WhatTheWorld.sln
          dotnet publish WhatTheWorld.sln -c Release -o ./publish

          mkdir -p ${{ github.workspace }}/temp_backend_publish
          rsync -a ./publish/ ${{ github.workspace }}/temp_backend_publish/

      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build

      - name: Copy Backend to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "temp_backend_publish/*"
          target: "/var/www/whattheworld_temp/backend/"
          strip_components: 0

      - name: Copy Frontend to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/var/www/whattheworld_temp/frontend/"
          strip_components: 0

      - name: Deploy and restart services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            # Backend deployen
            sudo mkdir -p /var/www/whattheworld/backend
            sudo rsync -av --delete /var/www/whattheworld_temp/backend/ /var/www/whattheworld/backend/

            # Frontend-Build direkt in wwwroot legen
            sudo rm -rf /var/www/whattheworld/backend/wwwroot
            sudo mkdir -p /var/www/whattheworld/backend/wwwroot
            sudo rsync -av --delete /var/www/whattheworld_temp/frontend/ /var/www/whattheworld/backend/wwwroot/

            # Temp-Verzeichnis aufr√§umen
            sudo rm -rf /var/www/whattheworld_temp

            # Berechtigungen setzen
            sudo chown -R www-data:www-data /var/www/whattheworld/backend/
            sudo find /var/www/whattheworld/backend -type d -exec chmod 755 {} \;
            sudo find /var/www/whattheworld/backend -type f -exec chmod 644 {} \;
            sudo chmod 755 /var/www/whattheworld/backend/WhatTheWorld.Api.dll

            # Dienste neu starten (Configs bleiben auf dem Server)
            sudo systemctl daemon-reload
            sudo systemctl restart whattheworld-backend

            sudo nginx -t
            sudo systemctl reload nginx
