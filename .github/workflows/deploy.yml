name: Deploy to Hetzner

on:
  push:
    branches: [ "main" ] # Oder "master", je nach deinem Branch-Namen

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Code auschecken
    - uses: actions/checkout@v4

    # 2. .NET Backend bauen
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x' # Passe dies an deine Version an (z.B. 10.0 wenn verfügbar, sonst 8.0/9.0)
    
    - name: Build Backend
      run: |
        cd backend 
        dotnet publish -c Release -o ./publish

    # 3. React Frontend bauen
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build

    # 4. Dateien auf den Server kopieren (via SCP)
    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "backend/publish/*,frontend/dist/*"
        target: "/var/www/whattheworld_temp"
        strip_components: 0

    # 5. Deployment auf dem Server finalisieren
    - name: Move files and restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Backend verschieben
          rsync -a /var/www/whattheworld_temp/backend/publish/ /var/www/whattheworld/backend/
          
          # Frontend verschieben
          rsync -a /var/www/whattheworld_temp/frontend/dist/ /var/www/whattheworld/frontend/
          
          # Temp löschen
          rm -rf /var/www/whattheworld_temp
          
          # Service neustarten (erstellen wir gleich im nächsten Schritt)
          systemctl restart whattheworld-backend || true