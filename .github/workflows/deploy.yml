name: Deploy to Hetzner

on:
  push:
    branches: [ "main" ] # Oder "master", je nach deinem Branch-Namen

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Code auschecken
    - uses: actions/checkout@v4

    # 2. .NET Backend bauen (Angepasst)
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x' # Wichtig: Nutze die korrekte .NET Version

    - name: Build Backend
      run: |
        # 1. Zuerst Pakete wiederherstellen
        cd backend/src
        dotnet restore WhatTheWorld.sln
        
        # 2. Solution publishen. Wir entfernen --no-restore
        # WARNUNG NETSDK1194 ignorieren und den korrekten Output-Ordner angeben
        dotnet publish WhatTheWorld.sln -c Release -o ./publish
        
        # 3. Den finalen API-Code in ein temp-Verzeichnis verschieben
        # Dies vereinfacht den folgenden Upload (Schritt 4)
        mkdir -p ../temp_backend_publish
        rsync -a ./publish/WhatTheWorld.Api/ ../temp_backend_publish/

    # 3. React Frontend bauen (Bleibt gleich)
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build

    # 4. Dateien auf den Server kopieren (Angepasst)
    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        # Hier verwenden wir die neuen, vereinfachten Quellordner
        source: "temp_backend_publish/*,frontend/dist/*"
        target: "/var/www/whattheworld_temp"
        strip_components: 0

    # 5. Move files and restart (Angepasst)
    - name: Move files and restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Backend verschieben (die .dlls liegen jetzt direkt in /whattheworld_temp)
          rsync -a /var/www/whattheworld_temp/temp_backend_publish/ /var/www/whattheworld/backend/
          
          # Frontend verschieben
          rsync -a /var/www/whattheworld_temp/frontend/dist/ /var/www/whattheworld/frontend/
          
          # Temp l√∂schen
          rm -rf /var/www/whattheworld_temp
          
          # Service neustarten
          systemctl restart whattheworld-backend || true