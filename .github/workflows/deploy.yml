name: Deploy to Hetzner

on:
  push:
    branches: [ "main" ] # Oder "master", je nach deinem Branch-Namen

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Code auschecken
    - uses: actions/checkout@v4

    # 2. .NET Backend bauen (FINAL KORRIGIERT)
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build Backend
      run: |
        # 1. In das SLN-Verzeichnis wechseln und Pakete wiederherstellen
        cd backend/src
        dotnet restore WhatTheWorld.sln
        
        # 2. Solution publishen. Output liegt in ./publish
        dotnet publish WhatTheWorld.sln -c Release -o ./publish
        
        # 3. Die fertigen Binaries in den temporären Upload-Ordner VERSCHIEBEN.
        #    Der Ordner MUSS im Repo-Root liegen, damit SCP ihn findet.
        #    Wir nutzen hier absoluten Pfad zum Repo-Root: ${{ github.workspace }}
        
        # Sicherstellen, dass der Upload-Ordner existiert (im Repo-Root)
        mkdir -p ${{ github.workspace }}/temp_backend_publish
        
        # Verschiebe den Output (./publish/*) in den neuen temporären Ordner
        rsync -a ./publish/ ${{ github.workspace }}/temp_backend_publish/   

    # 3. React Frontend bauen (Bleibt gleich)
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build

    # 4. Dateien auf den Server kopieren (JETZT ZUVERLÄSSIGER!)
    # Wir laden beide Ordner einzeln hoch, um Fehler zu vermeiden.
    - name: Copy Backend to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "temp_backend_publish/*" # Wir kopieren den INHALT
        target: "/var/www/whattheworld_temp/backend/"
        strip_components: 0

    - name: Copy Frontend to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "frontend/dist/*" # Wir kopieren den INHALT
        target: "/var/www/whattheworld_temp/frontend/"
        strip_components: 0

    # 5. Move files and restart (Angepasst für neue Temp-Struktur)
    - name: Move files and restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # 1. Backend verschieben
          rsync -av --delete /var/www/whattheworld_temp/backend/ /var/www/whattheworld/backend/
          
          # 2. Frontend verschieben
          rsync -av --delete /var/www/whattheworld_temp/frontend/ /var/www/whattheworld/frontend/
          
          # 3. Temp löschen
          rm -rf /var/www/whattheworld_temp
          
          # 4. Berechtigungen setzen (wichtig für 203/EXEC Fehlerbehebung)
          chmod 755 /var/www/whattheworld/backend/WhatTheWorld.Api.dll
          
          # 5. Service neustarten
          systemctl restart whattheworld-backend || true